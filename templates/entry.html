<div style="padding-left: 6rem; padding-right: 6rem; padding-top: 15%">
  <div x-data="{ login: true, showspinner: false, modalOpen: false, otpError: '' }">
    <h1 class="mb-4 flex justify-center" x-show="login">Login</h1>
    <h1 class="mb-4 flex justify-center" x-show="!login">Register</h1>
    <!-- prettier-ignore -->
    {{template "login-form"}}
    {{template "register-form"}}
    {{template "otp-modal"}}
    {{template "loading-spinner"}}
  </div>
</div>

<!-- -->

{{ define "login-form" }}
<div class="flex flex-col justify-center items-center" x-show="login">
  <form method="post" action="" class="inline-flex gap-2 justify-center w-80" enctype="multipart/form-data">
    <input type="text" name="email" placeholder="example@example.com" autocomplete="email" />
    <button type="submit" class="hidden md:block">Login</button>
    <button type="submit" class="md:hidden">&gt;</button>
  </form>
  <div class="place-content-end">
    <button x-on:click="login = false" class="cursor-pointer">
      No account? Register
    </button>
  </div>
</div>
{{ end }}

<!-- -->

{{ define "register-form" }}
<div class="flex flex-col justify-center items-center" x-show="!login">
  <form class="content-center w-80" id="register-form" enctype="multipart/form-data" x-on:submit.prevent="async () => {
      const form = document.getElementById('register-form');
      const formData = new FormData(form);

      try {
        showspinner = true;
        const response = await fetch('/register', {
          method: 'POST',
          body: formData,
        });
        showspinner = false;

        if (response.ok) {
          modalOpen = true; // Open OTP verification modal
        } else {
          const error = await response.text();
          console.error('Error during registration:', error);
          alert('Registration failed: ' + error);
        }
      } catch (error) {
        showspinner = false;
        console.error('Network error:', error);
        alert('An error occurred: ' + error.message);
      }
    }">
    {{ $label := list "Email" "Name" "Student ID" }}
    {{ $name := list "email" "name" "studentId" }}
    {{ $placeholder := list "example@example.com" "Your name" "Your student ID" }}
    {{ $autocomplete := list "email" "name" "id" }}
    {{ range $i, $v := $label }}
    <div class="mb-3">
      <label class="form-label">{{ $v }}</label>
      <input type="text" name="{{ index $name $i }}" placeholder="{{ index $placeholder $i }}" class="form-control"
        autocomplete="{{ index $autocomplete $i }}" />
    </div>
    {{ end }}
    <button type="submit" class="btn btn-primary">Register</button>
  </form>
  <div class="flex w-full justify-center items-center">
    <button x-on:click="login = true" class="cursor-pointer">
      Have an account? Login
    </button>
  </div>
</div>
{{end}}
<!-- -->


{{ define "otp-modal" }}
<div x-show="modalOpen" x-transition
  class="absolute h-screen w-screen top-0 left-0 bg-gray-500/30 backdrop-blur-sm flex items-center justify-center"
  id="otp-modal">
  <div class="bg-white p-6 rounded shadow-md w-96">
    <h2 class="text-xl font-bold mb-4">Verify OTP</h2>
    <p class="text-gray-600 mb-2">Please check your email for the OTP to complete verification.</p>
    <form id="otp-form" x-data x-on:submit.prevent="async () => {
        const otpInput = $event.target.elements.otp.value;
        if (!otpInput) {
          otpError = 'OTP cannot be empty!';
          return;
        }
        otpError = ''; // Clear error message

        try {
          const response = await fetch('/verify-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ otp: otpInput }),
          });

          if (response.ok) {
            modalOpen = false; // Close modal
            login = true; // Switch to login page
          } else {
            otpError = await response.text(); // Show error message
          }
        } catch (error) {
          console.error('Network error:', error);
          otpError = 'Network error. Please try again.';
        }
      }">
      <div class="mb-4">
        <label for="otp" class="block text-gray-700">Enter OTP:</label>
        <input type="text" id="otp" name="otp" class="w-full border border-gray-300 rounded p-2 mt-1"
          placeholder="Enter your OTP" />
      </div>
      <p class="text-red-500 text-sm" x-text="otpError"></p>
      <div class="flex justify-end gap-4">
        <button type="button" class="bg-gray-300 text-gray-700 rounded px-4 py-2" x-on:click="modalOpen = false">
          Cancel
        </button>
        <button type="submit" class="bg-blue-500 text-white rounded px-4 py-2">
          Verify
        </button>
      </div>
    </form>
  </div>
</div>
{{end}}

<!-- -->

{{ define "loading-spinner"}}
<!-- Loading Spinner -->
<div class="fixed top-0 left-0 w-full h-full bg-black/50 flex items-center justify-center" x-show="showspinner">
  <div class="loader">Loading...</div>
</div>
{{end}}